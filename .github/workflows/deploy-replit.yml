name: Deploy to Replit

on:
  push:
    branches: [main]
    paths:
      # Only deploy when server-related files change
      - 'codeshift/api/**'
      - 'requirements*.txt'
      - 'pyproject.toml'
      - '.replit'
      - 'replit.nix'

  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Replit Deploy
        run: |
          # Method 1: If using Replit Deploy Hook URL
          if [ -n "${{ secrets.REPLIT_DEPLOY_HOOK }}" ]; then
            echo "Triggering Replit deploy webhook..."
            curl -X POST "${{ secrets.REPLIT_DEPLOY_HOOK }}" \
              -H "Content-Type: application/json" \
              -d '{"trigger": "github-push"}' \
              --fail --silent --show-error
            echo "Deploy triggered!"
          else
            echo "::warning::REPLIT_DEPLOY_HOOK secret not configured. Skipping auto-deploy."
            echo "To enable auto-deploy:"
            echo "1. In Replit, go to Deployments > Settings"
            echo "2. Copy the Deploy Hook URL"
            echo "3. Add it as REPLIT_DEPLOY_HOOK secret in GitHub repo settings"
          fi

      - name: Notify deployment
        if: success()
        run: echo "Replit deployment triggered for commit ${{ github.sha }}"
